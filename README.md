# Музыкальный Бот для Discord

Музыкальный бот для Discord, разработанный на Python с использованием библиотеки discord.py. Позволяет воспроизводить музыку в голосовых каналах, управлять очередью треков и контролировать воспроизведение.

## Структура проекта

Проект имеет модульную структуру для упрощения поддержки и расширения:

- `main.py` - Точка входа в программу, инициализация бота
- `config.py` - Конфигурационные настройки и параметры
- `ytdl_source.py` - Модуль для работы с аудио-источниками YouTube
- `player.py` - Модуль музыкального плеера и управления очередью
- `music_commands.py` - Модуль с командами для управления музыкой
- `ssl_fix.py` - Утилита для исправления проблем с SSL сертификатами

## Функциональность

- Воспроизведение музыки из YouTube
- Поиск по названию трека без необходимости указывать ссылку
- Управление очередью треков
- Пауза/возобновление воспроизведения
- Повтор треков (новая функция)
- Переключение между треками
- Отображение текущего трека и очереди
- Воспроизведение плейлистов YouTube (новая функция)

## Команды

- `!join` - Бот присоединяется к голосовому каналу
- `!play <url или название>` - Воспроизводит трек или добавляет его в очередь
- `!playlist <url плейлиста>` - Воспроизводит все треки из плейлиста YouTube
- `!pause` - Ставит трек на паузу
- `!resume` - Возобновляет воспроизведение
- `!skip` - Пропускает текущий трек
- `!loop` - Включает/выключает повтор текущего трека
- `!queue` - Показывает очередь треков
- `!now` - Показывает текущий трек
- `!stop` - Останавливает воспроизведение и очищает очередь
- `!leave` - Отключается от голосового канала

## Установка

1. Убедитесь, что у вас установлен Python 3.8 или новее
2. Клонируйте репозиторий или скачайте файлы
3. Установите необходимые зависимости:
   ```
   pip install -r requirements.txt
   ```
4. Установите FFmpeg (https://ffmpeg.org/download.html)
5. Создайте файл `.env` и добавьте в него строку:
   ```
   DISCORD_TOKEN=ВАШ_ТОКЕН_СЮДА
   ```
   Или, при запуске, бот запросит токен в консоли
6. Запустите бота:
   ```
   python main.py
   ```

## Требуемые зависимости

- discord.py - Библиотека для работы с Discord API
- yt-dlp - Современная библиотека для загрузки и обработки контента с YouTube
- PyNaCl - Для обработки голосовых данных
- async-timeout - Для асинхронной работы с таймаутами
- python-dotenv - Для работы с переменными окружения
- certifi - Для работы с SSL сертификатами
- requests - Для выполнения HTTP-запросов
- FFmpeg (внешняя программа) - Для обработки аудио

## Создание бота в Discord

1. Перейдите на [Discord Developer Portal](https://discord.com/developers/applications)
2. Нажмите "New Application" и создайте приложение
3. Перейдите в раздел "Bot" и нажмите "Add Bot"
4. Скопируйте токен бота и добавьте его в файл `.env`
5. В разделе "Bot" включите права "MESSAGE CONTENT INTENT"
6. В разделе "OAuth2" -> "URL Generator" выберите scope "bot" и разрешения "Connect", "Speak", "Send Messages", "Use Voice Activity"
7. Используйте сгенерированную ссылку для добавления бота на сервер

## Примечания

- Для корректной работы бота необходимо установить FFmpeg и добавить его в PATH
- Бот может искать музыку по названию, не только по ссылкам
- Поддерживается работа с плейлистами YouTube
- При возникновении проблем убедитесь, что все зависимости установлены правильно
- Если бот не может найти музыку, попробуйте указать полную ссылку на YouTube

## Устранение неполадок

- Если возникают ошибки с извлечением аудио, убедитесь что yt-dlp установлен последней версии:
  ```
  pip install -U yt-dlp
  ```

- При ошибках **SSL: CERTIFICATE_VERIFY_FAILED** запустите скрипт исправления SSL:
  ```
  python ssl_fix.py
  ```
  И следуйте инструкциям на экране, или выполните одно из этих решений:
  
  1. Обновите сертификаты:
     ```
     pip install -U certifi
     ```
  2. Для Windows 10/11: обновите корневые сертификаты системы:
     ```
     python -m pip install --upgrade pip
     pip install certifi
     python -c "import ssl; print(ssl.get_default_verify_paths())"
     ```
  3. Настройте системное время и дату - неправильные настройки могут вызывать проблемы с проверкой сертификатов
  4. Попробуйте использовать VPN, если проблема связана с региональными ограничениями

- Если есть проблемы с FFmpeg, убедитесь что он корректно установлен и доступен в PATH

## Улучшения после рефакторинга

1. **Улучшенная обработка ошибок**
   - Добавлена детальная обработка SSL-ошибок
   - Реализованы повторные попытки при сбоях подключения
   - Информативные сообщения об ошибках для пользователей

2. **Улучшенная работа с плейлистами**
   - Корректное определение плейлистов YouTube
   - Оптимизированная загрузка плейлистов
   - Информация о прогрессе загрузки

3. **Оптимизация воспроизведения**
   - Исправлена проблема с подключением к голосовым каналам
   - Улучшена стабильность потокового воспроизведения
   - Оптимизирована работа очереди воспроизведения

4. **Улучшенное управление ресурсами**
   - Автоматическая очистка неиспользуемых ресурсов
   - Корректное освобождение памяти при отключении
   - Оптимизированное использование ffmpeg

5. **Производительность**
   - Асинхронная обработка запросов
   - Оптимизированная работа с YouTube API
   - Уменьшение задержек при воспроизведении

6. **Улучшенный пользовательский опыт**
   - Более информативные сообщения о статусе
   - Эмодзи для лучшей визуальной обратной связи
   - Понятные сообщения об ошибках

7. **Технические улучшения**
   - Модульная структура кода
   - Улучшенная обработка конфигурации
   - Поддержка современных версий Python и библиотек

## Лицензия

MIT
